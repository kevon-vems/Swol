@page "/workoutlogs/edit/{Id:int}"
@inject Swol.Data.ApplicationDbContext Db
@inject NavigationManager Nav
@using Swol.Data.Models
@using Microsoft.EntityFrameworkCore

<PageTitle>Edit Workout Log</PageTitle>

<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
    <h1 class="text-3xl font-bold">Edit Workout Log</h1>
    <div>
        @if (log?.EndTime == null)
        {
            <button type="button" class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded" @onclick="CompleteWorkout">Complete Workout</button>
        }
        else
        {
            <span class="inline-block bg-green-100 text-green-800 text-sm font-semibold px-3 py-2 rounded">Completed</span>
        }
    </div>
</div>

@if (log == null || workouts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="@log" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        
        <div class="flex flex-col md:flex-row gap-6 mb-6">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Workout</label>
                <InputSelect class="block w-full rounded border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" @bind-Value="log.WorkoutId">
                    <option value="">-- Select Workout --</option>
                    @foreach (var workout in workouts)
                    {
                        <option value="@workout.Id">@workout.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                <InputDate class="block w-full rounded border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" @bind-Value="log.StartTime" />
            </div>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">Mesocycle (Optional)</label>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex-1">
                    <InputSelect class="block w-full rounded border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" @bind-Value="selectedMesocycleId">
                        <option value="">-- No Mesocycle --</option>
                        @foreach (var mesocycle in mesocycles)
                        {
                            <option value="@mesocycle.Id">@mesocycle.Name @(mesocycle.IsActive ? "(Active)" : "")</option>
                        }
                    </InputSelect>
                </div>
                <div class="flex-1">
                    @if (selectedMesocycleId.HasValue)
                    {
                        <InputSelect class="block w-full rounded border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" @bind-Value="log.MesocycleWeek">
                            <option value="">-- Select Week --</option>
                            @for (int i = 1; i <= selectedMesocycle?.NumberOfWeeks; i++)
                            {
                                <option value="@i">Week @i @(i == selectedMesocycle?.NumberOfWeeks ? "(Deload)" : "")</option>
                            }
                        </InputSelect>
                    }
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
            <InputTextArea class="block w-full rounded border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" @bind-Value="log.Notes" rows="3" />
        </div>
        
        <button type="submit" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">Save</button>
        <a class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded ml-2" href="/workoutlogs">Cancel</a>
    </EditForm>
    
    <hr class="my-8" />
    
    <h3 class="text-xl font-semibold mb-4">Exercise Sets</h3>
    
    @if (!log.ExerciseSets.Any())
    {
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded">
            No exercise sets recorded yet. Add some below.
        </div>
    }
    else
    {
        <div class="overflow-x-auto mb-6">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                <thead>
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Exercise</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Set</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Reps</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Weight (kg)</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Duration</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Notes</th>
                        <th class="px-4 py-2 border-b"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var exerciseGroup in log.ExerciseSets.GroupBy(es => es.ExerciseId).OrderBy(g => g.Min(es => es.Id)))
                    {
                        var exercise = exercises.FirstOrDefault(e => e.Id == exerciseGroup.Key);
                        var sets = exerciseGroup.OrderBy(es => es.SetNumber).ToList();
                        
                        <tr class="bg-gray-50">
                            <td colspan="7" class="px-4 py-2 font-semibold text-gray-700">@exercise?.Name</td>
                        </tr>
                        
                        @foreach (var set in sets)
                        {
                            <tr>
                                <td></td>
                                <td class="px-4 py-2">@set.SetNumber</td>
                                <td class="px-4 py-2">@set.Reps</td>
                                <td class="px-4 py-2">@set.WeightInKg</td>
                                <td class="px-4 py-2">@(set.Duration?.ToString(@"mm\:ss") ?? "-")</td>
                                <td class="px-4 py-2">@set.Notes</td>
                                <td class="px-4 py-2 space-x-2">
                                    <a href="/exercisesets/edit/@set.Id" class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded text-sm">Edit</a>
                                    <a href="/exercisesets/delete/@set.Id" class="inline-block bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded text-sm">Delete</a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    
    <div class="mb-8">
        <a href="/exercisesets/create?workoutLogId=@log.Id" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">Add Exercise Set</a>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private WorkoutLog? log;
    private List<Workout>? workouts;
    private List<Mesocycle> mesocycles = new();
    private List<Exercise> exercises = new();
    private int? selectedMesocycleId;
    private Mesocycle? selectedMesocycle => selectedMesocycleId.HasValue 
                                          ? mesocycles.FirstOrDefault(m => m.Id == selectedMesocycleId)
                                          : null;

    protected override async Task OnInitializedAsync()
    {
        log = await Db.WorkoutLogs
            .Include(wl => wl.ExerciseSets)
            .FirstOrDefaultAsync(wl => wl.Id == Id);
            
        if (log == null)
        {
            Nav.NavigateTo("/workoutlogs");
            return;
        }
        
        workouts = await Db.Workouts.OrderBy(w => w.Name).ToListAsync();
        mesocycles = await Db.Mesocycles
            .OrderByDescending(m => m.IsActive)
            .ThenByDescending(m => m.StartDate)
            .ToListAsync();
            
        exercises = await Db.Exercises.ToListAsync();
        
        selectedMesocycleId = log.MesocycleId;
    }

    private async Task HandleValidSubmit()
    {
        log!.MesocycleId = selectedMesocycleId;
        Db.Update(log);
        await Db.SaveChangesAsync();
        Nav.NavigateTo("/workoutlogs");
    }
    
    private async Task CompleteWorkout()
    {
        if (log != null && log.EndTime == null)
        {
            log.EndTime = DateTime.Now;
            Db.Update(log);
            await Db.SaveChangesAsync();
            await OnInitializedAsync();
        }
    }
}
