@page "/exercises/edit/{Id:int}"
@inject Swol.Data.ApplicationDbContext Db
@inject NavigationManager Navigation
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer

<PageTitle>Edit Exercise</PageTitle>

<div class="max-w-4xl mx-auto p-4 space-y-6">

<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-2xl font-bold">Edit Exercise</h1>
    <div class="flex items-center gap-3">
        <button type="submit" form="exerciseEditForm" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow">Save</button>
        <a class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded shadow" href="/exercises">Cancel</a>
    </div>
</div>

@if (exercise == null || muscleGroups == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm id="exerciseEditForm" Model="exercise" OnValidSubmit="HandleValidSubmit" FormName="ExerciseEditForm">
        <DataAnnotationsValidator />
        <ValidationSummary class="mb-4 text-red-600" />
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <InputText class="block w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" @bind-Value="exercise.Name" />
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <InputTextArea class="block w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" @bind-Value="exercise.Description" rows="3" />
        </div>

        <label class="block text-sm font-medium text-gray-700 mb-1">Muscle Groups</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <div>
                <div class="border rounded p-4 mb-3">
                    <h5 class="font-semibold mb-2">Available</h5>
                    <hr class="mb-2"/>
                    <div class="h-72 overflow-y-auto">
                        @foreach (var mg in availableMuscleGroups)
                        {
                            <div class="mb-2">
                                <button type="button" class="w-full text-left border border-gray-300 rounded px-3 py-2 hover:bg-gray-100 flex items-center justify-between" @onclick="() => AddMuscleGroup(mg)">
                                    <span>@mg.Name</span> <span class="text-gray-400">&gt;</span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
            
            <div>
                <div class="border rounded p-4 mb-3 bg-gray-50">
                    <h5 class="font-semibold mb-2">Selected</h5>
                    <hr class="mb-2"/>
                    <div class="h-72 overflow-y-auto">
                        @foreach (var mg in selectedMuscleGroups)
                        {
                            <div class="mb-2">
                                <button type="button" class="w-full text-left border border-gray-300 rounded px-3 py-2 hover:bg-gray-100 flex items-center" @onclick="() => RemoveMuscleGroup(mg)">
                                    <span class="text-gray-400 mr-2">&lt;</span><span>@mg.Name</span>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
}

</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Swol.Data.Models.Exercise? exercise;
    private List<Swol.Data.Models.MuscleGroup> muscleGroups = new();
    private List<Swol.Data.Models.MuscleGroup> selectedMuscleGroups = new();
    private List<Swol.Data.Models.MuscleGroup> availableMuscleGroups = new();

    protected override async Task OnInitializedAsync()
    {
        exercise = await Db.Exercises
            .Include(e => e.ExerciseMuscleGroups)
            .FirstOrDefaultAsync(e => e.Id == Id);
            
        muscleGroups = await Db.MuscleGroups.OrderBy(mg => mg.Name).ToListAsync();
        
        if (exercise == null)
        {
            Navigation.NavigateTo("/exercises");
            return;
        }

        // Get the selected muscle group IDs
        var selectedIds = exercise.ExerciseMuscleGroups.Select(emg => emg.MuscleGroupId).ToList();
        
        // Create the selected and available lists
        selectedMuscleGroups = muscleGroups.Where(mg => selectedIds.Contains(mg.Id)).ToList();
        availableMuscleGroups = muscleGroups.Where(mg => !selectedIds.Contains(mg.Id)).ToList();
    }

    private void AddMuscleGroup(Swol.Data.Models.MuscleGroup muscleGroup)
    {
        availableMuscleGroups.Remove(muscleGroup);
        selectedMuscleGroups.Add(muscleGroup);
        selectedMuscleGroups = selectedMuscleGroups.OrderBy(mg => mg.Name).ToList();
        availableMuscleGroups = availableMuscleGroups.OrderBy(mg => mg.Name).ToList();
        StateHasChanged();
    }

    private void RemoveMuscleGroup(Swol.Data.Models.MuscleGroup muscleGroup)
    {
        selectedMuscleGroups.Remove(muscleGroup);
        availableMuscleGroups.Add(muscleGroup);
        selectedMuscleGroups = selectedMuscleGroups.OrderBy(mg => mg.Name).ToList();
        availableMuscleGroups = availableMuscleGroups.OrderBy(mg => mg.Name).ToList();
        StateHasChanged();
    }

    private async Task HandleValidSubmit()
    {
        Db.Update(exercise!);
        
        // Remove old associations
        var oldEmgs = Db.ExerciseMuscleGroups.Where(emg => emg.ExerciseId == exercise!.Id).ToList();
        Db.ExerciseMuscleGroups.RemoveRange(oldEmgs);
        await Db.SaveChangesAsync(); // Persist removals first

        // Add new associations
        foreach (var mg in selectedMuscleGroups)
        {
            Db.ExerciseMuscleGroups.Add(new Swol.Data.Models.ExerciseMuscleGroup 
            { 
                ExerciseId = exercise!.Id, 
                MuscleGroupId = mg.Id 
            });
        }
        
        await Db.SaveChangesAsync(); // Persist additions
        Navigation.NavigateTo("/exercises");
    }
}
